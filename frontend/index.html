<!doctype html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
    <title>氣泡數監控程式</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.2/moment.min.js"></script>
    <!-- <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css"> -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js" charset="utf-8"></script>
    <!-- <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script> -->
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> -->
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"> -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/spacelab/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="./serverInfo.js"></script>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="page-header">
                <h1>統義玻璃股份有限公司 <small>氣泡數監控程式</small></h1>
                <span class="currentDate"></span>
            </div>
            <table id="situationTable" class="table table-bordered table-condensed table-hover table-striped">
                <caption><span class="currentDate"></span> 氣泡數統計</caption>
                <thead>
                    <tr id="tableHeading">
                    </tr>
                </thead>
                <tbody id="tableData">
                </tbody>
            </table>
        </div>
    </div>
</body>

</html>

<script>
    var currentDate = moment().format("YYYY-MM-DD");

    var shiftList = [{
        reference: "day",
        cReference: "早班",
        start: "07:30",
        end: "15:30",
        inspectTimePoint: ['08:00', '10:00', '12:00', '14:00'],
        length: 480
    }, {
        reference: "night",
        cReference: "中班",
        start: "15:30",
        end: "23:30",
        inspectTimePoint: ['16:00', '18:00', '20:00', '22:00'],
        length: 480
    }, {
        reference: "graveYard",
        cReference: "夜班",
        start: "23:30",
        end: "07:30",
        inspectTimePoint: ['00:00', '02:00', '04:00', '06:00'],
        length: 480
    }];

    var facility = {
        reference: '新工總廠'
    };

    var prodLineList = [{
        reference: 'L1-1'
    }, {
        reference: 'L1'
    }, {
        reference: 'L2'
    }, {
        reference: 'L3'
    }, {
        reference: 'L5'
    }, {
        reference: 'L6'
    }, {
        reference: 'L7'
    }, {
        reference: 'L8'
    }];

    $("document").ready(function() {
        //initialize current date
        $(".currentDate").text(currentDate);
        constructSituationTable(getSeedCountData(currentDate));
    });

    var constructSituationTable = function(callback) {
        //construct the table heading
        $("#tableHeading").append('<th class="text-center">班次</th><th class="text-center">時間</th><th class="text-center">產品</th>');
        $.each(prodLineList, function(index, prodLine) {
            $("#tableHeading").append('<th class="text-center">' + prodLine.reference + '</th>');
        });
        //loop through each shift
        $.each(shiftList, function(index, shift) {
            //loop though each seed count examin check point
            $.each(shift.inspectTimePoint, function(index, timePoint) {
                var trimmedTimePoint = timePoint.slice(0, 2) + timePoint.slice(3);
                //create first three fields and add appropriate class attributes for identification
                $("#tableData").append('<tr class="processing"><td class="processing shiftColumn"></td><td class="processing timePointColumn"></td><td class="processing prodReferenceColumn"></td></tr>');
                $("tr.processing").addClass(shift.reference + ' ' + trimmedTimePoint);
                $("td.processing.shiftColumn").html(shift.cReference).addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                $("td.processing.timePointColumn").html(trimmedTimePoint).addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                $("td.processing.prodReferenceColumn").addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                //loop though each production line
                $.each(prodLineList, function(index, prodLine) {
                    //create one field for each production line and add appropriate class attributes for identification
                    $("tr.processing").append('<td class="seedCountColumn processing empty ' + prodLine.reference + '"></td>');
                    $("td." + prodLine.reference + ".processing").addClass("text-center 新工總廠 " + shift.reference + ' ' + trimmedTimePoint);
                });
                $(".processing").removeClass("processing"); //remove all temp processing class attrib
            });
        });
    };

    var getSeedCountData = function(date) {
        //ajax data and pass on data for processing
        $.getJSON(backendHost + "seedCount/api/dailySeedCountResult?date=" + date, function(result) {
            populateSituationTable(JSON.parse(result));
        });
    };

    var populateSituationTable = function(seedCountRecordSet) {
        $.each(seedCountRecordSet, function(index, seedCountRecord) {
            var seedCountCellSelector = "td.seedCountColumn." +
                seedCountRecord.prodLineID + "." +
                moment(seedCountRecord.recordDatetime).format("HH") +
                moment(seedCountRecord.recordDatetime).format("mm");
            $(seedCountCellSelector).append('<span class="label ' + (seedCountRecord.unitSeedCount > 10 ? "label-primary" : "label-success") + '">' + seedCountRecord.unitSeedCount + "</span>").removeClass("empty").addClass("filled");
        });
    };
</script>