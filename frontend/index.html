<!doctype html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
    <title>氣泡數監控程式</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js" charset="utf-8"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.2/moment.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.2/locale/zh-tw.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.9/moment-timezone-with-data.min.js"></script>
    <!-- <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css"> -->
    <!-- <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script> -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
    <!-- <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootswatch/3.3.7/spacelab/bootstrap.min.css"> -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="./serverInfo.js"></script>
    <script src="./model.js"></script>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="page-header">
                <h1>統義玻璃股份有限公司&nbsp;<small>氣泡數監控程式</small></h1>
                <h5 id="clockBanner"></h5>
            </div>
            <table id="situationTable" class="table table-bordered table-condensed table-hover">
                <caption>
                    <button id="editModeToggleButton" class="btn btn-default btn-lg" onclick="toggleEditMode()" disabled>修改模式</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <button id="previousButton" class="btn btn-default btn-lg navigation" onclick="previous()" disabled>前一日</button>
                    <button id="refreshButton" class="btn btn-default btn-lg navigation" onclick="refresh()" disabled>資料重整</button>
                    <button id="nextButton" class="btn btn-default btn-lg navigation" onclick="next()" disabled>下一日</button>
                    <button id="todayButton" class="btn btn-default btn-lg navigation" onclick="today()" disabled>返回今日</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <input id="designatedDate" type="date" class="input-lg">
                    <button id="switchDateButton" class="btn btn-default btn-lg navigation" onclick="switchToDate()" disabled>指定日期檢視</button>
                    <h3><span id="workingDateBanner"></span>&nbsp;氣泡數統計資料</h3>
                </caption>
                <thead>
                    <tr id="situationTableHeading">
                    </tr>
                </thead>
                <tbody id="situationTableDataSection">
                </tbody>
                <tfoot>
                    <tr id="situationTableFooter">
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</body>

</html>

<script>
    "use strict";
    var workingDatetime = moment();
    var workingDate = getWorkDateString(workingDatetime);
    var editMode = false;
    var buttonInaccessibleCounter = 5;
    var buttonInaccessibleCounterUpperLimit = 5;

    $("document").ready(function() {
        $("#designatedDate").val(workingDate);
        $("#clockBanner").text(workingDatetime.format("YYYY-MM-DD HH:mm:SS"));
        constructSituationTable(workingDatetime);
        autoRefresh();
    });

    function constructSituationTable(datetimeObject) {
        // construct the table heading
        $("#situationTableHeading").append('<th class="text-center">班次</th><th class="text-center">時間</th><th id="prodReferenceFieldLabel" class="text-center">產品</th>');
        $.each(prodLineList, function(index, prodLine) {
            $("#situationTableHeading").append('<th class="text-center">' + prodLine.reference + '</th>');
        });
        $("#situationTableHeading").append('<th class="text-center">平均</th>');
        // loop through each shift
        $.each(shiftList, function(index, shift) {
            //loop though each seed count examin check point
            $.each(shift.inspectTimePointList, function(index, timePoint) {
                var trimmedTimePoint = timePoint.slice(0, 2) + timePoint.slice(3);
                //create first three fields and add appropriate class attributes for identification
                $("#situationTableDataSection").append('<tr class="processing"><td class="processing shiftField"></td><td class="processing timePointField"></td><td class="processing prodReferenceField"></td></tr>');
                $("tr.processing").addClass(shift.reference + ' ' + trimmedTimePoint);
                $("td.processing.shiftField").html(shift.cReference).addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                $("td.processing.timePointField").html(trimmedTimePoint).addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                $("td.processing.prodReferenceField").addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                //loop though each production line
                $.each(prodLineList, function(index, prodLine) {
                    //create one field for each production line and add appropriate class attributes for identification
                    $("tr.processing").append('<td class="seedCountField processing empty ' + prodLine.reference + '"></td>');
                    $("td." + prodLine.reference + ".processing").addClass("text-center " + facilityList[0].cReference + " " + shift.reference + ' ' + trimmedTimePoint)
                        .data("workingDate", datetimeObject)
                        .data("timePoint", trimmedTimePoint)
                        .data("prodFacilityID", facilityList[0].cReference)
                        .data("prodLineID", prodLine.reference);
                });
                // add one cell for summary
                $("tr.processing").append('<th class="processing hourlyAverageField"></td>')
                $("th.processing.hourlyAverageField").addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                $(".processing").removeClass("processing"); // remove all temp processing class attrib
            });
        });
        // construct the footer summary section
        $("#situationTableFooter").append('<th id="situationTableFooterLabel" class="text-center" colspan="3">當日平均</th>');
        // loop though each production line
        $.each(prodLineList, function(index, prodLine) {
            $("#situationTableFooter").append('<th class="text-center prodLineAverageField ' + prodLine.reference + '"></th>');
        });
        // create daily overall summary
        $("#situationTableFooter").append('<th class="text-center dailyAverageField"></th>');
        // proceed to getting actual table data
        getSeedCountData(datetimeObject);
    };

    function getSeedCountData(workingDatetime) {
        $.getJSON(backendHost + "seedCount/api/recordCountOnDate?date=" + getWorkDateString(workingDatetime), function(result) {
            if (JSON.parse(result)[0].recordCount < 1) {
                $(".workingDateBanner").text(getWorkDateString(workingDatetime) + " 尚無"); //set the date label on the situation table caption
                //skip the table data population step and go straight to table formatting
                formatSituationTable();
            } else {
                $(".workingDateBanner").text(getWorkDateString(workingDatetime)); //set the date label on the situation table caption
                //ajax POST for seed count data and pass on the data for processing
                $.getJSON(backendHost + "seedCount/api/dailySeedCountResult?date=" + getWorkDateString(workingDatetime), function(result) {
                    populateSituationTable(JSON.parse(result));
                });
            }
        });
    };

    // populate data into the situation table
    function populateSituationTable(seedCountRecordSet) {
        // loop through each record
        $.each(seedCountRecordSet, function(index, seedCountRecord) {
            var recordDatetime = new Date(seedCountRecord.recordDatetime);
            var timePoint = padValue(recordDatetime.getUTCHours()) + padValue(recordDatetime.getUTCMinutes())
            console.log(seedCountRecord.recordDatetime);
            console.log(recordDatetime);
            console.log(timePoint);
            // construct identification info for product cell from the index'ed record
            var productReferenceCellSelector = "td.prodReferenceField" + "." +
                moment(seedCountRecord.recordDatetime).add(getHourTimezoneOffset(), 'h').format("HH") +
                moment(seedCountRecord.recordDatetime).format("mm");
            // using the ID info to grab the correct <td> to insert data
            $(productReferenceCellSelector).append('<div>' + seedCountRecord.prodReference + '</div>');
            // construct identification info for seedCount Cell from the index'ed record
            var seedCountCellSelector = "td.seedCountField." +
                seedCountRecord.prodLineID + "." +
                moment(seedCountRecord.recordDatetime).add(getHourTimezoneOffset(), 'h').format("HH") +
                moment(seedCountRecord.recordDatetime).format("mm");
            // using the ID info to grab the correct <td> to insert data
            $(seedCountCellSelector).append(Math.round(seedCountRecord.unitSeedCount * 100) / 100).removeClass("empty").addClass("filled");
        });
        //$("td,th").css("vertical-align", "middle");
        situationTableSummaryCalculation();
    };

    // after situation table is populated with data, this function calculate and displays summary information
    function situationTableSummaryCalculation() {
        // cycle through each shift (每兩小時當日平均)
        $.each(shiftList, function(index, shift) {
            //cycle through each inspectTimePoint
            $.each(shift.inspectTimePointList, function(index, timePoint) {
                var validEntryCount = 0,
                    seedCountSum = 0;
                var trimmedTimePoint = timePoint.slice(0, 2) + timePoint.slice(3);
                //cycle through each bi-hourly <tr> and count the valid entries and get the sum of the entries
                $("td.seedCountField.filled." + trimmedTimePoint).each(function(index, seedCountCell) {
                    seedCountSum += Number($(this).text());
                    validEntryCount++;
                });
                if (validEntryCount > 0) {
                    // if there are valid entries, calculate the bi-hourly average
                    $("th.hourlyAverageField." + trimmedTimePoint).text(Math.round(((Math.round(seedCountSum * 100) / 100) / validEntryCount) * 100) / 100);
                }
            });
        });
        // cycle through each production line (每線當日平均)
        $.each(prodLineList, function(index, prodLine) {
            var validEntryCount = 0,
                seedCountSum = 0;
            $("td.seedCountField.filled." + prodLine.reference).each(function(index, seedCountCell) {
                seedCountSum += Number($(this).text());
                validEntryCount++;
            });
            if (validEntryCount > 0) {
                //if there are valid entries, calculate the bi-hourly average
                $("th.prodLineAverageField." + prodLine.reference).text(Math.round(((Math.round(seedCountSum * 100) / 100) / validEntryCount) * 100) / 100);
            }
        });
        // daily overall average
        var validEntryCount = 0,
            seedCountSum = 0;
        $("td.seedCountField.filled").each(function(index, seedCountCell) {
            seedCountSum += Number($(this).text());
            validEntryCount++;
        });
        if (validEntryCount > 0) {
            //if there are valid entries, calculate the bi-hourly average
            $("th.dailyAverageField").text(Math.round(((Math.round(seedCountSum * 100) / 100) / validEntryCount) * 100) / 100);
        }
        formatSituationTable();
    };

    function formatSituationTable() {
        $("td,th").css("vertical-align", "middle");
        $("td.day.seedCountField").addClass("success");
        $("td.night.seedCountField").addClass("warning");
        $("td.graveYard.seedCountField").addClass("info");
        $("td,th").css("border", "1px solid black");
        $("th#prodReferenceFieldLabel,td.prodReferenceField").css("display", "none");
        $("th#situationTableFooterLabel").attr("colspan", "2");
        $("td.filled,th.hourlyAverageField,th.prodLineAverageField,th.dailyAverageField").each(function(index, filledSeedCountField) {
            switch (true) {
                case ($(this).text() < seedCountLevelCap[0].ceiling):
                    $(this).css("color", "green");
                    break;
                case ($(this).text() < seedCountLevelCap[1].ceiling):
                    $(this).css("color", "black");
                    break;
                case ($(this).text() < seedCountLevelCap[2].ceiling):
                    $(this).css("font-weight", "bold").css("color", "blue");
                    break;
                default:
                    $(this).css("font-weight", "bold").css("color", "red");
                    break;
            }
        });
        if (editMode === true) {
            editSeedCountField();
        }
    };

    function editSeedCountField() {
        //add click-n-edit/insert functionality to seedCountField cells
        $("td.seedCountField").click(function() {
            $(this).addClass("editing");
            var currentDatetime = new Date();
            var seedCountRecord = {
                recordDatetime: $(this).data("workingDate") + 'T' + $(this).data("timePoint").slice(0, 2) + ":" + $(this).data("timePoint").slice(2, 4) + ":00" + '.000Z',
                prodFacilityID: $(this).data("prodFacilityID"),
                prodLineID: $(this).data("prodLineID"),
                productReference: "NULL",
                thickness: "NULL",
                count_0: "NULL",
                count_1: "NULL",
                count_2: "NULL",
                count_3: "NULL",
                count_4: "NULL",
                count_5: "NULL",
                note: "NULL",
                photoLocation: "NULL",
                created: currentDatetime.getUTCFullYear() + '-' +
                    padValue(currentDatetime.getUTCMonth() + 1) + '-' +
                    padValue(currentDatetime.getUTCDate()) + 'T' +
                    padValue(currentDatetime.getUTCHours()) + ':' +
                    padValue(currentDatetime.getUTCMinutes()) + ':' +
                    padValue(currentDatetime.getUTCSeconds()) + '.000Z'
            };
            if ($("td.editing").hasClass("filled")) {
                $.getJSON(backendHost + "seedCount/api/retrieveRecord?" +
                    "recordDatetime=" + seedCountRecord.recordDatetime +
                    "&prodFacilityID=" + seedCountRecord.prodFacilityID +
                    "&prodLineID=" + seedCountRecord.prodLineID,
                    function(recordSet) {
                        var currentRecord = JSON.parse(recordSet)[0];
                        Object.keys(currentRecord).forEach(function(currentRecordIndex, index) {
                            if (
                                (currentRecordIndex !== 'recordDatetime') &&
                                (currentRecordIndex !== 'prodFacilityID') &&
                                (currentRecordIndex !== 'prodLineID') &&
                                (currentRecord[currentRecordIndex] !== null)) {
                                //console.log(index + ':' + currentRecordIndex + ' - ' + currentRecord[currentRecordIndex]);
                                seedCountRecord[currentRecordIndex] = currentRecord[currentRecordIndex];
                            }
                        });
                        //$("td.editing").append('<div id="temporaryContainer"></div>');
                        $("td.editing").load("./clickNEditTemplate.html");
                    });
            } else {
                console.log("click and insert not implemented yet...");
            }
        });
    };

    function autoRefresh() {
        var now = new Date();
        setInterval(function() {
            now = new Date();
            //every second decrease the buttonInaccessibleCount by 1
            decreaseInaccessibleCounter(1);
            //enable/disable buttons depending on the value of buttonInaccessibleCounter variable
            if (buttonInaccessibleCounter > 0) {
                $("button").prop("disabled", true);
            } else {
                $("button").prop("disabled", false);
            }
            //at 58 second mark before each scheduled situation table update, increase the buttonInaccessibleCount by 5
            if ((now.getUTCMinutes() % 10 == 0) && (now.getUTCSeconds() === 58)) {
                increaseInaccessibleCounter(5);
            }
            //set situation table to refresh every 10 minutes
            if ((now.getUTCMinutes() % 10 == 0) && (now.getUTCSeconds() % 60 == 0)) {
                refresh();
            }
            //update the clock banner
            $("#datetimeBanner").text(
                now.getUTCFullYear() + '-' +
                padValue(now.getUTCMonth() + 1) + '-' +
                padValue(now.getUTCDate()) + ' ' +
                padValue(now.getUTCHours()) + ':' +
                padValue(now.getUTCMinutes()) + ':' +
                padValue(now.getUTCSeconds())
            );
        }, 1000);
    };

    function switchToDate() {
        increaseInaccessibleCounter(10, 10);
        if ($("#designatedDate").val() !== '') {
            $("span.workingDate").empty();
            $("tr#situationTableFooter").empty();
            $("tbody#situationTableDataSection").empty();
            $("tr#situationTableHeading").empty();
            workingDate = $("#designatedDate").val();
            constructSituationTable(workingDate);
        }
    }

    function previous() {
        increaseInaccessibleCounter(10, 10);
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        workingDate = currentDatetime.getUTCFullYear() + '-' + padValue(currentDatetime.getUTCMonth()) + '-' + padValue(currentDatetime.getUTCDate());
        constructSituationTable(workingDate);
    };

    function refresh() {
        increaseInaccessibleCounter(10, 10);
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        constructSituationTable(workingDate);
    };

    function today() {
        increaseInaccessibleCounter(10, 10);
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        workingDate = currentDatetime.getUTCFullYear() + '-' + padValue(currentDatetime.getUTCMonth() + 1) + '-' + padValue(currentDatetime.getUTCDate());
        constructSituationTable(workingDate);
    };

    function next() {
        increaseInaccessibleCounter(10, 10);
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        workingDate = currentDatetime.getUTCFullYear() + '-' + padValue(currentDatetime.getUTCMonth() + 2) + '-' + padValue(currentDatetime.getUTCDate());
        constructSituationTable(workingDate);
    };

    function toggleEditMode() {
        if (editMode === true) {
            editMode = false;
            $("#editModeToggleButton").removeClass("btn-primary").addClass("btn-default");
            refresh();
        } else {
            editMode = true;
            $("#editModeToggleButton").removeClass("btn-default").addClass("btn-primary");
            refresh();
        }
    }

    function decreaseInaccessibleCounter(numberOfSecond) {
        if (buttonInaccessibleCounter - numberOfSecond >= 0) {
            buttonInaccessibleCounter -= numberOfSecond;
        }
    }

    function increaseInaccessibleCounter(numberOfSecond) {
        if ((buttonInaccessibleCounter + numberOfSecond) <= buttonInaccessibleCounterUpperLimit) {
            buttonInaccessibleCounter += numberOfSecond;
        } else {
            buttonInaccessibleCounter = buttonInaccessibleCounterUpperLimit;
        }
    }

    function getWorkDateString(datetimeObject) {
        var beginningOfWorkDay = moment(datetimeObject.format("YYYY-MM-DD") + ' 07:30:00');
        if (datetimeObject >= beginningOfWorkDay) {
            return (datetimeObject.format("YYYY-MM-DD"));
        } else {
            return (beginningOfWorkDay.add(-1, "day").format("YYYY-MM-DD"));
        }
    };
</script>