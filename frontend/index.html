<!doctype html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
    <title>氣泡數監控程式</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.2/moment.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js" charset="utf-8"></script>
    <!-- <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css"> -->
    <!-- <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script> -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
    <!-- <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootswatch/3.3.7/spacelab/bootstrap.min.css"> -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="./serverInfo.js"></script>
    <script src="./model.js"></script>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="page-header">
                <h1>統義玻璃股份有限公司 <small>氣泡數監控程式</small></h1>
                <span class="currentDate"></span>
            </div>
            <table id="situationTable" class="table table-bordered table-condensed table-hover">
                <caption>
                    <button class="btn btn-default" onclick="previous()">前一日</button>
                    <button class="btn btn-default" onclick="refresh()">資料重整</button>
                    <button class="btn btn-default" onclick="next()">下一日</button>
                    <button class="btn btn-default" onclick="today()">返回今日</button>
                    <h3><span class="workingDate"></span> 氣泡數統計資料</h3>
                </caption>
                <thead>
                    <tr id="situationTableHeading">
                    </tr>
                </thead>
                <tbody id="situationTableDataSection">
                </tbody>
                <tfoot>
                    <tr id="situationTableFooter">
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</body>

</html>

<script>
    "use strict";
    var currentDate = moment().format("YYYY-MM-DD");
    $(".currentDate").text(currentDate);
    var workingDate = currentDate;

    $("document").ready(function() {
        constructSituationTable(workingDate);
        formatSituationTable();
    });

    function formatSituationTable() {
        $("td.day.seedCountField").addClass("success");
        $("td.night.seedCountField").addClass("warning");
        $("td.graveYard.seedCountField").addClass("info");
        $("td,th").css("border", "1px solid black");
    }

    function constructSituationTable(WorkingDate) {
        // construct the table heading
        $("#situationTableHeading").append('<th class="text-center">班次</th><th class="text-center">時間</th><th class="text-center">產品</th>');
        $.each(prodLineList, function(index, prodLine) {
            $("#situationTableHeading").append('<th class="text-center">' + prodLine.reference + '</th>');
        });
        $("#situationTableHeading").append('<th class="text-center">平均</th>');
        // loop through each shift
        $.each(shiftList, function(index, shift) {
            //loop though each seed count examin check point
            $.each(shift.inspectTimePointList, function(index, timePoint) {
                var trimmedTimePoint = timePoint.slice(0, 2) + timePoint.slice(3);
                //create first three fields and add appropriate class attributes for identification
                $("#situationTableDataSection").append('<tr class="processing"><td class="processing shiftField"></td><td class="processing timePointField"></td><td class="processing prodReferenceField"></td></tr>');
                $("tr.processing").addClass(shift.reference + ' ' + trimmedTimePoint);
                $("td.processing.shiftField").html(shift.cReference).addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                $("td.processing.timePointField").html(trimmedTimePoint).addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                $("td.processing.prodReferenceField").addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                //loop though each production line
                $.each(prodLineList, function(index, prodLine) {
                    //create one field for each production line and add appropriate class attributes for identification
                    $("tr.processing").append('<td class="seedCountField processing empty ' + prodLine.reference + '"></td>');
                    $("td." + prodLine.reference + ".processing").addClass("text-center " + facilityList[0].cReference + " " + shift.reference + ' ' + trimmedTimePoint);
                });
                // add one cell for summary
                $("tr.processing").append('<th class="processing hourlyAverageField"></td>')
                $("th.processing.hourlyAverageField").addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                $(".processing").removeClass("processing"); // remove all temp processing class attrib
            });
        });
        // construct the footer summary section
        $("#situationTableFooter").append('<th class="text-center" colspan="3">當日平均</th>');
        // loop though each production line
        $.each(prodLineList, function(index, prodLine) {
            $("#situationTableFooter").append('<th class="text-center prodLineAverageField ' + prodLine.reference + '"></th>');
        });
        // create daily overall summary
        $("#situationTableFooter").append('<th class="text-center dailyAverageField"></th>');
        getSeedCountData(WorkingDate);
    };

    function getSeedCountData(date) {
        $.getJSON(backendHost + "seedCount/api/recordCountOnDate?date=" + date, function(result) {
            if (JSON.parse(result)[0].recordCount < 1) {
                $(".workingDate").text(date + " 尚無"); //set the date label on the situation table caption
            } else {
                $(".workingDate").text(date); //set the date label on the situation table caption
                //ajax POST for seed count data and pass on the data for processing
                $.getJSON(backendHost + "seedCount/api/dailySeedCountResult?date=" + date, function(result) {
                    populateSituationTable(JSON.parse(result));
                });
            }
        });
    };

    // populate data into the situation table
    function populateSituationTable(seedCountRecordSet) {
        // loop through each record
        $.each(seedCountRecordSet, function(index, seedCountRecord) {
            // construct identification info for product cell from the index'ed record
            var productReferenceCellSelector = "td.prodReferenceField" + "." +
                moment(seedCountRecord.recordDatetime).add(getHourTimezoneOffset(), 'h').format("HH") +
                moment(seedCountRecord.recordDatetime).format("mm");
            // using the ID info to grab the correct <td> to insert data
            $(productReferenceCellSelector).append('<div>' + seedCountRecord.prodReference + '</div>');
            // construct identification info for seedCount Cell from the index'ed record
            var seedCountCellSelector = "td.seedCountField." +
                seedCountRecord.prodLineID + "." +
                moment(seedCountRecord.recordDatetime).add(getHourTimezoneOffset(), 'h').format("HH") +
                moment(seedCountRecord.recordDatetime).format("mm");
            // using the ID info to grab the correct <td> to insert data
            $(seedCountCellSelector).append(Math.round(seedCountRecord.unitSeedCount * 100) / 100).removeClass("empty").addClass("filled");
        });
        $("td,th").css("vertical-align", "middle");
        situationTableSummaryCalculation();
    };

    // after situation table is populated with data, this function calculate and displays summary information
    function situationTableSummaryCalculation() {
        // cycle through each shift (每兩小時當日平均)
        $.each(shiftList, function(index, shift) {
            //cycle through each inspectTimePoint
            $.each(shift.inspectTimePointList, function(index, timePoint) {
                var validEntryCount = 0,
                    seedCountSum = 0;
                var trimmedTimePoint = timePoint.slice(0, 2) + timePoint.slice(3);
                //cycle through each bi-hourly <tr> and count the valid entries and get the sum of the entries
                $("td.seedCountField.filled." + trimmedTimePoint).each(function(index, seedCountCell) {
                    seedCountSum += Number($(this).text());
                    validEntryCount++;
                });
                if (validEntryCount > 0) {
                    // if there are valid entries, calculate the bi-hourly average
                    $("th.hourlyAverageField." + trimmedTimePoint).text(Math.round(((Math.round(seedCountSum * 100) / 100) / validEntryCount) * 100) / 100);
                }
            });
        });
        // cycle through each production line (每線當日平均)
        $.each(prodLineList, function(index, prodLine) {
            var validEntryCount = 0,
                seedCountSum = 0;
            $("td.seedCountField.filled." + prodLine.reference).each(function(index, seedCountCell) {
                seedCountSum += Number($(this).text());
                validEntryCount++;
            });
            if (validEntryCount > 0) {
                //if there are valid entries, calculate the bi-hourly average
                $("th.prodLineAverageField." + prodLine.reference).text(Math.round(((Math.round(seedCountSum * 100) / 100) / validEntryCount) * 100) / 100);
            }
        });
        // daily overall average
        var validEntryCount = 0,
            seedCountSum = 0;
        $("td.seedCountField.filled").each(function(index, seedCountCell) {
            seedCountSum += Number($(this).text());
            validEntryCount++;
        });
        if (validEntryCount > 0) {
            //if there are valid entries, calculate the bi-hourly average
            $("th.dailyAverageField").text(Math.round(((Math.round(seedCountSum * 100) / 100) / validEntryCount) * 100) / 100);
        }
    };

    function previous() {
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        workingDate = moment(workingDate).add(-1, 'd').format("YYYY-MM-DD");
        constructSituationTable(workingDate);
        formatSituationTable();
    };

    function refresh() {
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        constructSituationTable(workingDate);
        formatSituationTable();
    };

    function today() {
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        workingDate = moment().format("YYYY-MM-DD");
        constructSituationTable(workingDate);
        formatSituationTable();
    };

    function next() {
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        workingDate = moment(workingDate).add(1, 'd').format("YYYY-MM-DD");
        constructSituationTable(workingDate);
        formatSituationTable();
    };

    //utility function to return the Hour offset when using mement.js due to timezone issue
    var getHourTimezoneOffset = function() {
        var dateValue = new Date();
        var hourTimezoneOffset = dateValue.getTimezoneOffset() / 60;
        return hourTimezoneOffset;
    };
</script>