<!doctype html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
    <title>氣泡數監控程式</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.2/moment.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.2/locale/zh-tw.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.9/moment-timezone-with-data.min.js"></script>
    <!-- <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css"> -->
    <!-- <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script> -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
    <!-- <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootswatch/3.3.7/spacelab/bootstrap.min.css"> -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="./serverInfo.js"></script>
    <script src="./model.js"></script>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="page-header">
                <h1>統義玻璃股份有限公司&nbsp;<small>氣泡數監控程式</small></h1>
                <h5 id="clockBanner"></h5>
            </div>
            <table id="situationTable" class="table table-bordered table-condensed table-hover">
                <caption>
                    <button id="preventDisplayToggleButton" class="btn btn-default btn-lg" onclick="togglePreventDisplay()">顯示</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <button id="editModeToggleButton" class="btn btn-default btn-lg" onclick="toggleEditMode()" disabled>修改模式</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <button id="previousButton" class="btn btn-default btn-lg navigation" onclick="previous()" disabled>前一日</button>
                    <button id="refreshButton" class="btn btn-default btn-lg navigation" onclick="refresh()" disabled>資料重整</button>
                    <button id="nextButton" class="btn btn-default btn-lg navigation" onclick="next()" disabled>下一日</button>
                    <button id="todayButton" class="btn btn-default btn-lg navigation" onclick="today()" disabled>返回今日</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <input id="designatedDate" type="date" class="input-lg">
                    <button id="switchDateButton" class="btn btn-default btn-lg navigation" onclick="switchToDate()" disabled>檢視指定日期資料</button>
                    <h3><span id="workingDateBanner"></span>&nbsp;氣泡數統計資料</h3>
                </caption>
                <thead>
                    <tr id="situationTableHeading">
                    </tr>
                </thead>
                <tbody id="situationTableDataSection">
                </tbody>
                <tfoot>
                    <tr id="situationTableFooter">
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</body>

</html>

<script>
    "use strict";
    var hideProdReferenceColumn = true;
    var preventDisplay = true;
    var workingTimezone = "Asia/Taipei";
    var initializeDatetime = moment.tz(moment(), workingTimezone);
    var workingDate = getWorkDateString(initializeDatetime);
    var editMode = false;
    var editModeInProgress = false;
    var buttonInaccessibleCounter = 5;
    var buttonInaccessibleCounterUpperLimit = 5;

    $("document").ready(function() {
        $("#clockBanner").text(initializeDatetime.format("YYYY-MM-DD HH:mm:ss"));
        $("#designatedDate").val(workingDate);
        constructSituationTable(workingDate);
        autoRefresh();
    });

    function constructSituationTable(dateString) {
        // construct the table heading
        $("#situationTableHeading").append('<th class="text-center">班次</th><th class="text-center">時間</th><th id="prodReferenceFieldLabel" class="text-center">產品</th>');
        $.each(prodLineList, function(index, prodLine) {
            $("#situationTableHeading").append('<th class="text-center ' + prodLine.reference + '">' + prodLine.reference + '</th>');
            //check if the index production line has the hidden property being true, if so, add a prevent display class attributes
            if (prodLine.hidden === true) {
                $("th." + prodLine.reference).addClass("preventDisplay");
            }
        });
        $("#situationTableHeading").append('<th class="text-center">平均</th>');
        // loop through each shift
        $.each(shiftList, function(index, shift) {
            //loop though each seed count examin check point
            $.each(shift.inspectTimePointList, function(index, inspectTimePoint) {
                //create first three fields and add appropriate class attributes for identification
                $("#situationTableDataSection").append('<tr class="processing"><td class="processing shiftField"></td><td class="processing timePointField"></td><td class="processing prodReferenceField"></td></tr>');
                $("tr.processing").addClass(shift.reference + ' ' + inspectTimePoint.trimmedTimePoint);
                $("td.processing.shiftField").html(shift.cReference).addClass("text-center " + shift.reference + ' ' + inspectTimePoint.trimmedTimePoint);
                $("td.processing.timePointField").html(inspectTimePoint.trimmedTimePoint).addClass("text-center " + shift.reference + ' ' + inspectTimePoint.trimmedTimePoint);
                $("td.processing.prodReferenceField").addClass("text-center " + shift.reference + ' ' + inspectTimePoint.trimmedTimePoint);
                //review the shiftList for items with hidden property of true, add a 'preventDisplay' class
                if (inspectTimePoint.hidden === true) {
                    $("tr.processing." + inspectTimePoint.trimmedTimePoint).addClass("preventDisplay");
                }
                //loop though each production line
                $.each(prodLineList, function(index, prodLine) {
                    //create one field for each production line and add appropriate class attributes for identification
                    $("tr.processing").append('<td class="seedCountField processing empty ' + prodLine.reference + '"></td>');
                    $("td." + prodLine.reference + ".processing").addClass("text-center " + facilityList[0].cReference + " " + shift.reference + ' ' + inspectTimePoint.trimmedTimePoint)
                        .data("workingDate", dateString)
                        .data("timePoint", inspectTimePoint.trimmedTimePoint)
                        .data("prodFacilityID", facilityList[0].cReference)
                        .data("prodLineID", prodLine.reference);
                    //review the prodLineList for items with hidden property of true, add a 'preventDisplay' class
                    if (prodLine.hidden === true) {
                        $("td.processing." + prodLine.reference).addClass("preventDisplay");
                    }
                });
                // add one cell for summary
                $("tr.processing").append('<th class="processing hourlyAverageField"></td>')
                $("th.processing.hourlyAverageField").addClass("text-center " + shift.reference + ' ' + inspectTimePoint.trimmedTimePoint);
                $(".processing").removeClass("processing"); // remove all temp processing class attrib
            });
        });
        // construct the footer summary section
        $("#situationTableFooter").append('<th id="situationTableFooterLabel" class="text-center" colspan="3">當日平均</th>');
        // loop though each production line
        $.each(prodLineList, function(index, prodLine) {
            $("#situationTableFooter").append('<th class="text-center prodLineAverageField ' + prodLine.reference + '"></th>');
            //review the prodLineList for items with hidden property of true, add a 'preventDisplay' class
            if (prodLine.hidden === true) {
                $("th.prodLineAverageField." + prodLine.reference).addClass("preventDisplay");
            }
        });
        // create daily overall summary
        $("#situationTableFooter").append('<th class="text-center dailyAverageField"></th>');
        // proceed to getting actual table data
        getSeedCountData(dateString);
    };

    function getSeedCountData(dateString) {
        $.getJSON(backendHost + "seedCount/api/getRecordCountOnDate?workingDate=" + dateString, function(result) {
            if (JSON.parse(result)[0].recordCount < 1) {
                $("#workingDateBanner").text(dateString + " 尚無"); //set the date label on the situation table caption
                //skip the table data population step and go straight to table formatting
                formatSituationTable();
            } else {
                $("#workingDateBanner").text(dateString); //set the date label on the situation table caption
                //ajax POST for seed count data and pass on the data for processing
                $.getJSON(backendHost + "seedCount/api/getRecordsetOnDate?workingDate=" + dateString, function(result) {
                    populateSituationTable(JSON.parse(result));
                });
            }
        });
    };

    // populate data into the situation table
    function populateSituationTable(seedCountRecordSet) {
        // loop through each record
        $.each(seedCountRecordSet, function(index, seedCountRecord) {
            var recordDatetime = moment(seedCountRecord.recordDatetime, "YYYY-MM-DD HH:mm:ss");
            // construct identification info for product cell from the index'ed record
            var productReferenceCellSelector = "td.prodReferenceField" + "." + recordDatetime.format("HHmm");
            // using the ID info to grab the correct <td> to insert data
            $(productReferenceCellSelector).append('<div>' + seedCountRecord.prodReference + '</div>');
            // construct identification info for seedCount Cell from the index'ed record
            var seedCountCellSelector = "td.seedCountField." + seedCountRecord.prodLineID + "." + recordDatetime.format("HHmm");
            // using the ID info to grab the correct <td> to insert data
            $(seedCountCellSelector).append(Math.round(seedCountRecord.unitSeedCount * 100) / 100).removeClass("empty").addClass("filled");
        });
        $("td,th").css("vertical-align", "middle");
        situationTableSummaryCalculation();
    };

    // after situation table is populated with data, this function calculate and displays summary information
    function situationTableSummaryCalculation() {
        // cycle through each shift (每兩小時當日平均)
        $.each(shiftList, function(index, shift) {
            //cycle through each inspectTimePoint
            $.each(shift.inspectTimePointList, function(index, inspectTimePoint) {
                var validEntryCount = 0,
                    seedCountSum = 0;
                //cycle through each bi-hourly <tr> and count the valid entries and get the sum of the entries
                $("td.seedCountField.filled." + inspectTimePoint.trimmedTimePoint).each(function(index, seedCountCell) {
                    seedCountSum += Number($(this).text());
                    validEntryCount++;
                });
                if (validEntryCount > 0) {
                    // if there are valid entries, calculate the bi-hourly average
                    $("th.hourlyAverageField." + inspectTimePoint.trimmedTimePoint).text(Math.round(((Math.round(seedCountSum * 100) / 100) / validEntryCount) * 100) / 100);
                }
            });
        });
        // cycle through each production line (每線當日平均)
        $.each(prodLineList, function(index, prodLine) {
            var validEntryCount = 0,
                seedCountSum = 0;
            $("td.seedCountField.filled." + prodLine.reference).each(function(index, seedCountCell) {
                seedCountSum += Number($(this).text());
                validEntryCount++;
            });
            if (validEntryCount > 0) {
                //if there are valid entries, calculate the bi-hourly average
                $("th.prodLineAverageField." + prodLine.reference).text(Math.round(((Math.round(seedCountSum * 100) / 100) / validEntryCount) * 100) / 100);
            }
        });
        // daily overall average
        var validEntryCount = 0,
            seedCountSum = 0;
        $("td.seedCountField.filled").each(function(index, seedCountCell) {
            seedCountSum += Number($(this).text());
            validEntryCount++;
        });
        if (validEntryCount > 0) {
            //if there are valid entries, calculate the bi-hourly average
            $("th.dailyAverageField").text(Math.round(((Math.round(seedCountSum * 100) / 100) / validEntryCount) * 100) / 100);
        }
        formatSituationTable();
    };

    function formatSituationTable() {
        $("td,th").css("vertical-align", "middle");
        $("td.day.seedCountField").addClass("success");
        $("td.night.seedCountField").addClass("warning");
        $("td.graveYard.seedCountField").addClass("info");
        $("td,th").css("border", "1px solid gray");
        if (hideProdReferenceColumn === true) {
            $("th#prodReferenceFieldLabel,td.prodReferenceField").css("display", "none");
            $("th#situationTableFooterLabel").attr("colspan", "2");
        }
        $("td.filled,th.hourlyAverageField,th.prodLineAverageField,th.dailyAverageField").each(function(index, filledSeedCountField) {
            switch (true) {
                case ($(this).text() < seedCountLevelCap[0].ceiling):
                    $(this).css("color", "green");
                    break;
                case ($(this).text() < seedCountLevelCap[1].ceiling):
                    $(this).css("color", "black");
                    break;
                case ($(this).text() < seedCountLevelCap[2].ceiling):
                    $(this).css("font-weight", "bold").css("color", "blue");
                    break;
                default:
                    $(this).css("font-weight", "bold").css("color", "red");
                    break;
            }
        });
        if (preventDisplay === true) {
            $(".preventDisplay").hide();
            $("button#preventDisplayToggleButton").text("顯示");
        } else {
            $(".preventDisplay").show();
            $("button#preventDisplayToggleButton").text("隱藏");
        }
        if (editMode === true) {
            editSeedCountField();
        }
    };

    function editSeedCountField() {
        //add click-n-edit/insert functionality to seedCountField cells
        $("td.seedCountField").click(function() {
            if (editModeInProgress === false) {
                editModeInProgress = true;
                var workingCell = $(this);
                var workingRow = $(this).parent();
                if (workingCell.hasClass("filled")) {
                    console.log("click and modify not implemented yet...");
                } else {
                    workingCell.removeClass("success warning info").css("background-color", "red"); // highlight elements being edited
                    workingRow.after('<tr class="dataEntryRow"></tr>'); // insert one row under the current <tr>
                    $("tr.dataEntryRow").load("./inlineEditTemplate.html", function(response, status) {
                        if (status === "success") {
                            $("input#recordDatetime").val(getWorkDatetimeString(
                                workingCell.data("workingDate"),
                                workingCell.data("timePoint").slice(0, 2) + ":" + workingCell.data("timePoint").slice(2)));
                            $("input#prodFacilityID").val(workingCell.data("prodFacilityID"));
                            $("input#prodLineID").val(workingCell.data("prodLineID"));
                            $("#prodReference").focus();
                            // when user presses cancel
                            $("input.inlineEditControl.seedCountField,input#thickness").on("change", function() {
                                var sum = 0;
                                var validFieldCount = 0;
                                if ($("input#thickness").val() !== "") {
                                    $("input.inlineEditControl.seedCountField").each(function(index) {
                                        if ($(this).val() !== "") {
                                            sum += Number($(this).val());
                                            validFieldCount++;
                                        }
                                    });
                                    if (validFieldCount > 0) {
                                        workingCell.text(Math.round((sum / validFieldCount) * (10 / Number($("input#thickness").val())) * 100) / 100);
                                    }
                                }
                            });
                            $("button#cancelInlineEdit").on("click", function() {
                                console.log("使用者取消編輯...");
                                editModeInProgress = false;
                                refresh();
                            });
                            // confirm form is ready for submission after this point
                            $("form#inlineEditForm").ajaxForm({
                                url: backendHost + "seedCount/api/insertRecord",
                                method: "post",
                                beforeSend: function() {
                                    editModeInProgress = false;
                                    $("input#created").val(moment.tz("Asia/Taipei").format("YYYY-MM-DD HH:mm:ss"));
                                    $("input#modified").val(moment.tz("Asia/Taipei").format("YYYY-MM-DD HH:mm:ss"));
                                },
                                complete: function() {
                                    refresh();
                                }
                            });
                            // when user submits the form
                            $("form#inlineEditForm").submit(function() {
                                $(this).ajaxSubmit();
                                return false;
                            });
                        } else {
                            console.log("編輯面版載入錯誤：" + status);
                            editModeInProgress = false;
                            refresh();
                        }
                    });
                }
            }
        });
    };

    function autoRefresh() {
        var now;
        setInterval(function() {
            now = moment.tz(moment(), workingTimezone);
            //every second decrease the buttonInaccessibleCount by 1
            decreaseInaccessibleCounter(1);
            //enable/disable buttons depending on the value of buttonInaccessibleCounter variable
            if (buttonInaccessibleCounter > 0) {
                $("button:not(button#preventDisplayToggleButton)").prop("disabled", true);
                $("input#submitInlineEdit,input#resetInlineEdit").prop("disabled", true);
            } else {
                $("button:not(button#preventDisplayToggleButton)").prop("disabled", false);
                $("input#submitInlineEdit,input#resetInlineEdit").prop("disabled", false);
            }
            //at 58 second mark before each scheduled situation table update, increase the buttonInaccessibleCount by 5
            if ((now.format("m") % 10 === 0) && (now.format("s") === 58)) {
                increaseInaccessibleCounter(5);
            }
            //set situation table to refresh every 10 minutes
            if ((now.format("m") % 10 === 0) && (now.format("s") % 60 == 0)) {
                refresh();
            }
            //update the clock banner
            $("#clockBanner").text(now.format("YYYY-MM-DD HH:mm:ss"));
        }, 1000);
    };

    function switchToDate() {
        increaseInaccessibleCounter(10, 10);
        if ($("#designatedDate").val() !== '') {
            $("span.workingDate").empty();
            $("tr#situationTableFooter").empty();
            $("tbody#situationTableDataSection").empty();
            $("tr#situationTableHeading").empty();
            editModeInProgress = false;
            workingDate = $("#designatedDate").val();
            constructSituationTable(workingDate);
        }
    }

    function previous() {
        increaseInaccessibleCounter(10, 10);
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        editModeInProgress = false;
        workingDate = moment.tz(workingDate, "Asia/Taipei").add(-1, "day").format("YYYY-MM-DD");
        constructSituationTable(workingDate);
    };

    function refresh() {
        increaseInaccessibleCounter(10, 10);
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        editModeInProgress = false;
        constructSituationTable(workingDate);
    };

    function today() {
        increaseInaccessibleCounter(10, 10);
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        editModeInProgress = false;
        workingDate = getWorkDateString(moment.tz(moment(), "Asia/Taipei"));
        constructSituationTable(workingDate);
    };

    function next() {
        increaseInaccessibleCounter(10, 10);
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        editModeInProgress = false;
        workingDate = moment.tz(workingDate, "Asia/Taipei").add(1, "day").format("YYYY-MM-DD");
        constructSituationTable(workingDate);
    };

    function togglePreventDisplay() {
        // prevent user from changing the preventDisplay status when inlineEdit mode is enabled
        // 1. to prevent unexpected behavior
        // 2. so that only visible cells should be possible to edit
        if (editMode === false) {
            if (preventDisplay === true) {
                preventDisplay = false;
                $(".preventDisplay").show();
                $("button#preventDisplayToggleButton").text("隱藏");
            } else {
                preventDisplay = true;
                $(".preventDisplay").hide();
                $("button#preventDisplayToggleButton").text("顯示");
            }
        }
    };

    function toggleEditMode() {
        if (editMode === true) {
            editMode = false;
            editModeInProgress = false;
            $("button#preventDisplayToggleButton").prop("disabled", "");
            $("button#editModeToggleButton").removeClass("btn-primary").addClass("btn-default").text("修改模式");
            refresh();
        } else {
            editMode = true;
            $("button#preventDisplayToggleButton").prop("disabled", "true");
            $("button#editModeToggleButton").removeClass("btn-default").addClass("btn-primary").text("取消修改模式");
            refresh();
        }
    }

    function decreaseInaccessibleCounter(numberOfSecond) {
        if (buttonInaccessibleCounter - numberOfSecond >= 0) {
            buttonInaccessibleCounter -= numberOfSecond;
        }
    }

    function increaseInaccessibleCounter(numberOfSecond) {
        if ((buttonInaccessibleCounter + numberOfSecond) <= buttonInaccessibleCounterUpperLimit) {
            buttonInaccessibleCounter += numberOfSecond;
        } else {
            buttonInaccessibleCounter = buttonInaccessibleCounterUpperLimit;
        }
    }

    function getWorkDateString(datetimeObject) {
        if (datetimeObject.isSameOrAfter(datetimeObject.format("YYYY-MM-DD") + ' 07:30:00')) {
            return (datetimeObject.tz("Asia/Taipei").format("YYYY-MM-DD"));
        } else {
            var tempMoment = moment(datetimeObject.format("YYYY-MM-DD HH:mm:ss"));
            return (tempMoment.add(-1, "day").tz("Asia/Taipei").format("YYYY-MM-DD"));
        }
    };

    function getWorkDatetimeString(workingDateString, workingTime) {
        switch (true) {
            case (workingTime == shiftList[0].inspectTimePointList[0].timePoint):
            case (workingTime == shiftList[0].inspectTimePointList[1].timePoint):
            case (workingTime == shiftList[0].inspectTimePointList[2].timePoint):
            case (workingTime == shiftList[0].inspectTimePointList[3].timePoint):
            case (workingTime == shiftList[1].inspectTimePointList[0].timePoint):
            case (workingTime == shiftList[1].inspectTimePointList[1].timePoint):
            case (workingTime == shiftList[1].inspectTimePointList[2].timePoint):
            case (workingTime == shiftList[1].inspectTimePointList[3].timePoint):
                return (moment(workingDateString).format("YYYY-MM-DD") + " " + workingTime + ":00");
                break;
            case (workingTime == shiftList[2].inspectTimePointList[0].timePoint):
            case (workingTime == shiftList[2].inspectTimePointList[1].timePoint):
            case (workingTime == shiftList[2].inspectTimePointList[2].timePoint):
            case (workingTime == shiftList[2].inspectTimePointList[3].timePoint):
                return (moment(workingDateString).add(1, "days").format("YYYY-MM-DD") + " " + workingTime + ":00");
                break;
            default:
                alert("發現錯誤時間資料，無法建置正確工作時間。請通知IT重新啟動系統後台服務...");
                refresh();
        }
    };
</script>