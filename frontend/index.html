<!doctype html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
    <title>氣泡數監控程式</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.2/moment.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js" charset="utf-8"></script>
    <!-- <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css"> -->
    <!-- <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script> -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
    <!-- <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootswatch/3.3.7/spacelab/bootstrap.min.css"> -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="./serverInfo.js"></script>
    <script src="./model.js"></script>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="page-header">
                <h1>統義玻璃股份有限公司 <small>氣泡數監控程式</small></h1>
                <span id="datetimeBanner"></span>
            </div>
            <table id="situationTable" class="table table-bordered table-condensed table-hover">
                <caption>
                    <button id="previousButton" class="btn btn-default navigation" onclick="previous()" disabled>前一日</button>
                    <button id="refreshButton" class="btn btn-default navigation" onclick="refresh()" disabled>資料重整</button>
                    <button id="nextButton" class="btn btn-default navigation" onclick="next()" disabled>下一日</button>
                    <button id="todayButton" class="btn btn-default navigation" onclick="today()" disabled>返回今日</button>
                    <button id="editModeToggleButton" class="btn btn-default" onclick="toggleEditMode()" disabled>修改模式</button>
                    <h3><span class="workingDate"></span> 氣泡數統計資料</h3>
                </caption>
                <thead>
                    <tr id="situationTableHeading">
                    </tr>
                </thead>
                <tbody id="situationTableDataSection">
                </tbody>
                <tfoot>
                    <tr id="situationTableFooter">
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</body>

</html>

<script>
    "use strict";
    var currentDatetime = new Date();
    var workingDate = moment().format("YYYY-MM-DD");
    var editMode = false;

    $("document").ready(function() {
        $("#datetimeBanner").text(
            currentDatetime.getFullYear() + '-' +
            padValue(currentDatetime.getMonth() + 1) + '-' +
            padValue(currentDatetime.getDay()) + ' ' +
            padValue(currentDatetime.getHours()) + ':' +
            padValue(currentDatetime.getMinutes()) + ':' +
            padValue(currentDatetime.getSeconds())
        );
        constructSituationTable(workingDate);
        autoRefresh();
    });

    function constructSituationTable(WorkingDate) {
        // construct the table heading
        $("#situationTableHeading").append('<th class="text-center">班次</th><th class="text-center">時間</th><th id="prodReferenceFieldLabel" class="text-center">產品</th>');
        $.each(prodLineList, function(index, prodLine) {
            $("#situationTableHeading").append('<th class="text-center">' + prodLine.reference + '</th>');
        });
        $("#situationTableHeading").append('<th class="text-center">平均</th>');
        // loop through each shift
        $.each(shiftList, function(index, shift) {
            //loop though each seed count examin check point
            $.each(shift.inspectTimePointList, function(index, timePoint) {
                var trimmedTimePoint = timePoint.slice(0, 2) + timePoint.slice(3);
                //create first three fields and add appropriate class attributes for identification
                $("#situationTableDataSection").append('<tr class="processing"><td class="processing shiftField"></td><td class="processing timePointField"></td><td class="processing prodReferenceField"></td></tr>');
                $("tr.processing").addClass(shift.reference + ' ' + trimmedTimePoint);
                $("td.processing.shiftField").html(shift.cReference).addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                $("td.processing.timePointField").html(trimmedTimePoint).addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                $("td.processing.prodReferenceField").addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                //loop though each production line
                $.each(prodLineList, function(index, prodLine) {
                    //create one field for each production line and add appropriate class attributes for identification
                    $("tr.processing").append('<td class="seedCountField processing empty ' + prodLine.reference + '"></td>');
                    $("td." + prodLine.reference + ".processing").addClass("text-center " + facilityList[0].cReference + " " + shift.reference + ' ' + trimmedTimePoint)
                        .data("workingDate", workingDate)
                        .data("timePoint", trimmedTimePoint)
                        .data("prodFacilityID", facilityList[0].cReference)
                        .data("prodLineID", prodLine.reference);
                });
                // add one cell for summary
                $("tr.processing").append('<th class="processing hourlyAverageField"></td>')
                $("th.processing.hourlyAverageField").addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                $(".processing").removeClass("processing"); // remove all temp processing class attrib
            });
        });
        // construct the footer summary section
        $("#situationTableFooter").append('<th id="situationTableFooterLabel" class="text-center" colspan="3">當日平均</th>');
        // loop though each production line
        $.each(prodLineList, function(index, prodLine) {
            $("#situationTableFooter").append('<th class="text-center prodLineAverageField ' + prodLine.reference + '"></th>');
        });
        // create daily overall summary
        $("#situationTableFooter").append('<th class="text-center dailyAverageField"></th>');
        // proceed to getting actual table data
        getSeedCountData(WorkingDate);
    };

    function getSeedCountData(date) {
        $.getJSON(backendHost + "seedCount/api/recordCountOnDate?date=" + date, function(result) {
            if (JSON.parse(result)[0].recordCount < 1) {
                $(".workingDate").text(date + " 尚無"); //set the date label on the situation table caption
                //skip the table data population step and go straight to table formatting
                formatSituationTable();
            } else {
                $(".workingDate").text(date); //set the date label on the situation table caption
                //ajax POST for seed count data and pass on the data for processing
                $.getJSON(backendHost + "seedCount/api/dailySeedCountResult?date=" + date, function(result) {
                    populateSituationTable(JSON.parse(result));
                });
            }
        });
    };

    // populate data into the situation table
    function populateSituationTable(seedCountRecordSet) {
        // loop through each record
        $.each(seedCountRecordSet, function(index, seedCountRecord) {
            // construct identification info for product cell from the index'ed record
            var productReferenceCellSelector = "td.prodReferenceField" + "." +
                moment(seedCountRecord.recordDatetime).add(getHourTimezoneOffset(), 'h').format("HH") +
                moment(seedCountRecord.recordDatetime).format("mm");
            // using the ID info to grab the correct <td> to insert data
            $(productReferenceCellSelector).append('<div>' + seedCountRecord.prodReference + '</div>');
            // construct identification info for seedCount Cell from the index'ed record
            var seedCountCellSelector = "td.seedCountField." +
                seedCountRecord.prodLineID + "." +
                moment(seedCountRecord.recordDatetime).add(getHourTimezoneOffset(), 'h').format("HH") +
                moment(seedCountRecord.recordDatetime).format("mm");
            // using the ID info to grab the correct <td> to insert data
            $(seedCountCellSelector).append(Math.round(seedCountRecord.unitSeedCount * 100) / 100).removeClass("empty").addClass("filled");
        });
        //$("td,th").css("vertical-align", "middle");
        situationTableSummaryCalculation();
    };

    // after situation table is populated with data, this function calculate and displays summary information
    function situationTableSummaryCalculation() {
        // cycle through each shift (每兩小時當日平均)
        $.each(shiftList, function(index, shift) {
            //cycle through each inspectTimePoint
            $.each(shift.inspectTimePointList, function(index, timePoint) {
                var validEntryCount = 0,
                    seedCountSum = 0;
                var trimmedTimePoint = timePoint.slice(0, 2) + timePoint.slice(3);
                //cycle through each bi-hourly <tr> and count the valid entries and get the sum of the entries
                $("td.seedCountField.filled." + trimmedTimePoint).each(function(index, seedCountCell) {
                    seedCountSum += Number($(this).text());
                    validEntryCount++;
                });
                if (validEntryCount > 0) {
                    // if there are valid entries, calculate the bi-hourly average
                    $("th.hourlyAverageField." + trimmedTimePoint).text(Math.round(((Math.round(seedCountSum * 100) / 100) / validEntryCount) * 100) / 100);
                }
            });
        });
        // cycle through each production line (每線當日平均)
        $.each(prodLineList, function(index, prodLine) {
            var validEntryCount = 0,
                seedCountSum = 0;
            $("td.seedCountField.filled." + prodLine.reference).each(function(index, seedCountCell) {
                seedCountSum += Number($(this).text());
                validEntryCount++;
            });
            if (validEntryCount > 0) {
                //if there are valid entries, calculate the bi-hourly average
                $("th.prodLineAverageField." + prodLine.reference).text(Math.round(((Math.round(seedCountSum * 100) / 100) / validEntryCount) * 100) / 100);
            }
        });
        // daily overall average
        var validEntryCount = 0,
            seedCountSum = 0;
        $("td.seedCountField.filled").each(function(index, seedCountCell) {
            seedCountSum += Number($(this).text());
            validEntryCount++;
        });
        if (validEntryCount > 0) {
            //if there are valid entries, calculate the bi-hourly average
            $("th.dailyAverageField").text(Math.round(((Math.round(seedCountSum * 100) / 100) / validEntryCount) * 100) / 100);
        }
        formatSituationTable();
    };

    function formatSituationTable() {
        $("td,th").css("vertical-align", "middle");
        $("td.day.seedCountField").addClass("success");
        $("td.night.seedCountField").addClass("warning");
        $("td.graveYard.seedCountField").addClass("info");
        $("td,th").css("border", "1px solid black");
        $("th#prodReferenceFieldLabel,td.prodReferenceField").css("display", "none");
        $("th#situationTableFooterLabel").attr("colspan", "2");
        $("td.filled,th.hourlyAverageField,th.prodLineAverageField,th.dailyAverageField").each(function(index, filledSeedCountField) {
            switch (true) {
                case ($(this).text() < seedCountLevelCap[0].ceiling):
                    $(this).css("color", "green");
                    break;
                case ($(this).text() < seedCountLevelCap[1].ceiling):
                    $(this).css("color", "black");
                    break;
                case ($(this).text() < seedCountLevelCap[2].ceiling):
                    $(this).css("font-weight", "bold").css("color", "blue");
                    break;
                default:
                    $(this).css("font-weight", "bold").css("color", "red");
                    break;
            }
        });
        if (editMode === true) {
            editSeedCountField();
        }
    };

    function editSeedCountField() {
        //add click-n-edit/insert functionality to seedCountField cells
        $("td.seedCountField").click(function() {
            $(this).addClass("editing");
            var currentDatetime = new Date();
            var seedCountRecord = {
                recordDatetime: $(this).data("workingDate") + 'T' + $(this).data("timePoint").slice(0, 2) + ":" + $(this).data("timePoint").slice(2, 4) + ":00" + '.000Z',
                prodFacilityID: $(this).data("prodFacilityID"),
                prodLineID: $(this).data("prodLineID"),
                productReference: "NULL",
                thickness: "NULL",
                count_0: "NULL",
                count_1: "NULL",
                count_2: "NULL",
                count_3: "NULL",
                count_4: "NULL",
                count_5: "NULL",
                note: "NULL",
                photoLocation: "NULL",
                created: currentDatetime.getFullYear() + '-' +
                    padValue(currentDatetime.getMonth() + 1) + '-' +
                    padValue(currentDatetime.getDay()) + 'T' +
                    padValue(currentDatetime.getHours()) + ':' +
                    padValue(currentDatetime.getMinutes()) + ':' +
                    padValue(currentDatetime.getSeconds()) + '.000Z'
            };
            if ($("td.editing").hasClass("filled")) {
                $.getJSON(backendHost + "seedCount/api/retrieveRecord?" +
                    "recordDatetime=" + seedCountRecord.recordDatetime +
                    "&prodFacilityID=" + seedCountRecord.prodFacilityID +
                    "&prodLineID=" + seedCountRecord.prodLineID,
                    function(recordSet) {
                        var currentRecord = JSON.parse(recordSet)[0];
                        Object.keys(currentRecord).forEach(function(currentRecordIndex, index) {
                            if (
                                (currentRecordIndex !== 'recordDatetime') &&
                                (currentRecordIndex !== 'prodFacilityID') &&
                                (currentRecordIndex !== 'prodLineID') &&
                                (currentRecord[currentRecordIndex] !== null)) {
                                //console.log(index + ':' + currentRecordIndex + ' - ' + currentRecord[currentRecordIndex]);
                                seedCountRecord[currentRecordIndex] = currentRecord[currentRecordIndex];
                            }
                        });
                        //$("td.editing").append('<div id="temporaryContainer"></div>');
                        $("td.editing").load("./clickNEditTemplate.html");
                    });
            } else {
                console.log("click and insert not implemented yet...");
            }
        });
    };

    function autoRefresh() {
        var now = new Date();
        var updateDatetimeBanner = function(clockBannerUpdateInterval) {
            setInterval(function() {
                now = new Date();
                //every first 5 and last 5 seconds, all buttons are disabled
                if ((now.getSeconds() >= 55) || (now.getSeconds() <= 5)) {
                    $("button").prop("disabled", true);
                    $("button#submit").prop("disabled", true);
                    $("button#cancel").prop("disabled", true);
                } else {
                    $("button").prop("disabled", false);
                    $("button#submit").prop("disabled", false);
                    $("button#cancel").prop("disabled", false);
                }
                //set data table to refresh every 60 seconds
                if (now.getSeconds() % 60 == 0) {
                    refresh();
                }
                $("#datetimeBanner").text(
                    now.getFullYear() + '-' +
                    padValue(now.getMonth() + 1) + '-' +
                    padValue(now.getDay()) + ' ' +
                    padValue(now.getHours()) + ':' +
                    padValue(now.getMinutes()) + ':' +
                    padValue(now.getSeconds())
                );
            }, clockBannerUpdateInterval * 1000);
        }(1);
    };

    function previous() {
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        workingDate = moment(workingDate).add(-1, 'd').format("YYYY-MM-DD");
        constructSituationTable(workingDate);
    };

    function refresh() {
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        constructSituationTable(workingDate);
    };

    function today() {
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        workingDate = moment().format("YYYY-MM-DD");
        constructSituationTable(workingDate);
    };

    function next() {
        $("span.workingDate").empty();
        $("tr#situationTableFooter").empty();
        $("tbody#situationTableDataSection").empty();
        $("tr#situationTableHeading").empty();
        workingDate = moment(workingDate).add(1, 'd').format("YYYY-MM-DD");
        constructSituationTable(workingDate);
    };

    function toggleEditMode() {
        if (editMode === true) {
            editMode = false;
            $("#editModeToggleButton").removeClass("btn-primary").addClass("btn-default");
            refresh();
        } else {
            editMode = true;
            $("#editModeToggleButton").removeClass("btn-default").addClass("btn-primary");
            refresh();
        }
    }

    //utility function to return the Hour offset when using mement.js due to timezone issue
    function getHourTimezoneOffset() {
        var dateValue = new Date();
        var hourTimezoneOffset = dateValue.getTimezoneOffset() / 60;
        return hourTimezoneOffset;
    };

    //utility function to pad time values(hour,minute,second) with preceeding zeros
    function padValue(valueToBePadded) {
        var str = "" + valueToBePadded;
        var pad = "00";
        var paddedValue = pad.substring(0, pad.length - str.length) + str;
        return paddedValue;
    }
</script>