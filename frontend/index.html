<!doctype html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
    <title>氣泡數監控程式</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.2/moment.min.js"></script>
    <!-- <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css"> -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js" charset="utf-8"></script>
    <!-- <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script> -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
    <!-- <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootswatch/3.3.7/spacelab/bootstrap.min.css"> -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="./serverInfo.js"></script>
    <script src="./model.js"></script>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="page-header">
                <h1>統義玻璃股份有限公司 <small>氣泡數監控程式</small></h1>
                <span class="currentDate"></span>
            </div>
            <table id="situationTable" class="table table-bordered table-condensed table-hover table-striped">
                <caption>
                    <h3><span class="workingDate"></span> 氣泡數統計結果</h3>
                </caption>
                <thead>
                    <tr id="situationTableHeading">
                    </tr>
                </thead>
                <tbody id="situationTableDataSection">
                </tbody>
                <tfoot>
                    <tr id="situationTableFooter">
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</body>

</html>

<script>
    var currentDate = moment().format("YYYY-MM-DD");
    $(".currentDate").text(currentDate);
    var workingDate = currentDate;

    $("document").ready(function() {
        //initialize current date
        constructSituationTable(getSeedCountData(workingDate));
    });

    var constructSituationTable = function(callback) {
        // construct the table heading
        $("#situationTableHeading").append('<th class="text-center">班次</th><th class="text-center">時間</th><th class="text-center">產品</th>');
        $.each(prodLineList, function(index, prodLine) {
            $("#situationTableHeading").append('<th class="text-center">' + prodLine.reference + '</th>');
        });
        $("#situationTableHeading").append('<th class="text-center">平均</th>');
        // loop through each shift
        $.each(shiftList, function(index, shift) {
            //loop though each seed count examin check point
            $.each(shift.inspectTimePoint, function(index, timePoint) {
                var trimmedTimePoint = timePoint.slice(0, 2) + timePoint.slice(3);
                //create first three fields and add appropriate class attributes for identification
                $("#situationTableDataSection").append('<tr class="processing"><td class="processing shiftField"></td><td class="processing timePointField"></td><td class="processing prodReferenceField"></td></tr>');
                $("tr.processing").addClass(shift.reference + ' ' + trimmedTimePoint);
                $("td.processing.shiftField").html(shift.cReference).addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                $("td.processing.timePointField").html(trimmedTimePoint).addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                $("td.processing.prodReferenceField").addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                //loop though each production line
                $.each(prodLineList, function(index, prodLine) {
                    //create one field for each production line and add appropriate class attributes for identification
                    $("tr.processing").append('<td class="seedCountField processing empty ' + prodLine.reference + '"></td>');
                    $("td." + prodLine.reference + ".processing").addClass("text-center " + facilityList[0].cReference + " " + shift.reference + ' ' + trimmedTimePoint);
                });
                // add one cell for summary
                $("tr.processing").append('<td class="processing hourlyAverageField"></td>')
                $("td.processing.hourlyAverageField").addClass("text-center " + shift.reference + ' ' + trimmedTimePoint);
                $(".processing").removeClass("processing"); // remove all temp processing class attrib
            });
        });
        // construct the footer summary section
        $("#situationTableFooter").append('<th class="text-center" colspan="3">當日平均</th>');
        // loop though each production line
        $.each(prodLineList, function(index, prodLine) {
            $("#situationTableFooter").append('<th class="text-center prodLineAverageField ' + prodLine.reference + '"></th>');
        });
        // create daily overall summary
        $("#situationTableFooter").append('<th class="text-center dailyAverageField"></th>');
    };

    var getSeedCountData = function(date) {
        //ajax POST for seed count data and pass on the data for processing
        $.getJSON(backendHost + "seedCount/api/dailySeedCountResult?date=" + date, function(result) {
            $(".workingDate").text(date); //set the date label on the situation table caption
            populateSituationTable(JSON.parse(result)); //pass on the data to seed the situationTable
        });
    };

    // populate data into the situation table
    var populateSituationTable = function(seedCountRecordSet) {
        // loop through each record
        $.each(seedCountRecordSet, function(index, seedCountRecord) {
            // construct identification info for product cell from the index'ed record
            var productReferenceCellSelector = "td.prodReferenceField" + "." +
                moment(seedCountRecord.recordDatetime).add(getHourTimezoneOffset(), 'h').format("HH") +
                moment(seedCountRecord.recordDatetime).format("mm");
            // using the ID info to grab the correct <td> to insert data
            $(productReferenceCellSelector).append('<div>' + seedCountRecord.prodReference + '</div>');
            // construct identification info for seedCount Cell from the index'ed record
            var seedCountCellSelector = "td.seedCountField." +
                seedCountRecord.prodLineID + "." +
                moment(seedCountRecord.recordDatetime).add(getHourTimezoneOffset(), 'h').format("HH") +
                moment(seedCountRecord.recordDatetime).format("mm");
            // using the ID info to grab the correct <td> to insert data
            $(seedCountCellSelector).append('<span class="label ' + (seedCountRecord.unitSeedCount > 10 ? "label-danger" : "label-success") + '">' + seedCountRecord.unitSeedCount + "</span>").removeClass("empty").addClass("filled");
        });
        $("td").css("vertical-align", "middle");
    };

    var getHourTimezoneOffset = function() {
        var dateValue = new Date();
        var hourTimezoneOffset = dateValue.getTimezoneOffset() / 60;
        return hourTimezoneOffset;
    };
</script>